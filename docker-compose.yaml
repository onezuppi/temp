version: '3'

services:
  marzban:
    container_name: marzban
    image: gozargah/marzban:latest
    env_file:
      - .env
    ports:
      - 443:443/tcp
    restart: unless-stopped
    networks:
      default:
        ipv4_address: 172.18.0.2
    volumes:
      - ./certbot/conf:/etc/ssl/certs:ro # certificates
      - ./xray:/usr/local/share/xray # geo-files
      - ./xray/xray:/usr/local/bin/xray # xray core
      - ./marzban/xray_config.json:/code/xray_config.json # xray core config
      - ./marzban/db.sqlite3:/code/db.sqlite3 # users DB
      - ./marzban/templates:/code/templates # templates for sub and pages
      - ./marzban/singbox.py:/code/app/subscription/singbox.py #signs 
  nginx:
      image: nginx:latest
      container_name: nginx
      restart: unless-stopped
      labels:
        proxy_nginx: "Для SSL"
      ports:
      - 443:443/tcp
      - 80:80/tcp
      env_file:
      - .env
      logging:
        driver: 'json-file'
        options:
          max-size: '10m'
      networks:
        default:
          ipv4_address: 172.18.0.3
      volumes:
        - ./nginx/error.log:/var/log/nginx/error.log
        - ./nginx/access.log:/var/log/nginx/access.log
        - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
        - ./certbot/www:/var/www/certbot/:ro
        - ./certbot/conf/:/etc/nginx/ssl/:ro
      command: [nginx-debug, "-g", "daemon off;"]
  letsencrypt:
    image: gordonchan/auto-letsencrypt
    links:
      - nginx
    volumes:
      - /var/log/letsencrypt/:/var/log/letsencrypt
      - /var/run/docker.sock:/var/run/docker.sock
      - /etc/letsencrypt:/etc/letsencrypt
      - /var/lib/letsencrypt:/var/lib/letsencrypt
      - /tmp/letsencrypt/www:/tmp/letsencrypt/www
      - ./certs:/etc/nginx/certs
    environment:
      - EMAIL=${EMAIL}
      - SERVER_CONTAINER=nginx
      - WEBROOT_PATH=/tmp/letsencrypt/www
      - CERTS_PATH=/etc/nginx/certs
      - DOMAINS=${DOMAIN}
      - CHECK_FREQ=1
      - SERVER_CONTAINER_LABEL=proxy_nginx
    restart: unless-stopped


networks:
  default:
    name: proxy
    ipam:
        config:
          - subnet: 172.18.0.0/16
            gateway: 172.18.0.1